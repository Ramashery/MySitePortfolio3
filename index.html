<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Craft | Portfolio</title>
    <meta name="description" content="Professional websites for small businesses">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.165.0/examples/jsm/"
        }
    }
    </script>

    <style>
        /* --- Global Variables --- */
        :root {
            --color-bg: #030409;
            --color-text: #eaf6ff; /* Всегда белый текст */
            --color-accent: #b8d8e8;
            --color-card: rgba(25, 29, 45, 0.4);
            --color-border: rgba(184, 216, 232, 0.2);
            --font-main: 'Cormorant Garamond', serif;
            --header-height: 80px;
        }

        /* --- Base Styles --- */
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text); /* Обеспечиваем белый цвет текста */
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            line-height: 1.6;
        }

        h1, h2, h3 {
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--color-text); /* Белый цвет для заголовков */
            font-family: var(--font-main); /* Применяем шрифт к заголовкам */
        }
        
        a {
            color: var(--color-accent);
            text-decoration: none;
            font-family: var(--font-main); /* Применяем шрифт к ссылкам */
        }

        /* --- Preloader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--color-bg); display: flex; justify-content: center;
            align-items: center; z-index: 10000; transition: opacity 0.5s ease-out;
        }
        .spinner {
            width: 50px; height: 50px; border: 3px solid var(--color-accent);
            border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- Crystal Canvas --- */
        #webgl-canvas {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh; z-index: 0;
            transition: opacity 0.5s ease-out; /* Для плавного появления/исчезновения */
        }
        /* Класс для скрытия канваса Three.js */
        #webgl-canvas.hidden {
            opacity: 0;
            pointer-events: none; /* Чтобы не мешал кликам */
        }


        /* --- Main content --- */
        main {
            position: relative; z-index: 2; max-width: 1200px;
            margin: 0 auto; padding: 100px 30px;
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            font-family: var(--font-main); /* Применяем шрифт к основному контенту */
        }
        body.modal-is-open main, body.nav-is-open main {
            opacity: 0; transform: translateY(20px); pointer-events: none;
        }

        /* --- Animation System --- */
        section {
            margin-bottom: 120px;
            perspective: 1000px;
        }

        .animated-container {
            opacity: 0;
            transform: translateX(-30px) rotate(-5deg);
            transition: all 0.7s cubic-bezier(0.2, 0.9, 0.3, 1.1);
        }

        .animated-container.active {
            opacity: 1;
            transform: none;
        }
        
        @keyframes letterAppear {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: none; }
        }

        .animated-text {
            /* Hide text initially before JS splits it */
             color: transparent; 
             font-family: var(--font-main); /* Применяем шрифт к анимированному тексту */
        }

        .animated-text.is-animating {
            color: initial; /* Restore color when animation starts */
        }

        .animated-text span {
            display: inline-block;
            opacity: 0;
            animation: letterAppear 0.5s forwards;
            font-family: var(--font-main); /* Применяем шрифт к каждому символу */
        }

        /* --- Generic Cards --- */
        .item-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px; margin-top: 40px;
        }
        .item-card {
            background: var(--color-card); /* MODIFIED: Set semi-transparent background */
            border: 1px solid var(--color-border);
            border-radius: 8px; overflow: hidden; cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-family: var(--font-main); /* Применяем шрифт к карточкам */
        }
        .item-card:hover {
            transform: translateY(-10px) scale(1.02) !important;
            border-color: var(--color-accent); box-shadow: 0 10px 30px rgba(184, 216, 232, 0.3);
        }
        .item-card__image {
            height: 200px;
            background: linear-gradient(135deg, rgba(184, 216, 232, 0.1), rgba(25, 29, 45, 0.7));
            background-size: cover; background-position: center;
            opacity: 1; transition: opacity 0.8s ease-in-out;
            position: relative;
            overflow: hidden;
        }
        .item-card__content { padding: 25px; }
        .item-card h3 { margin: 0 0 10px; font-size: 1.5rem; transition: color 0.3s ease-out; }
        .item-card:hover h3 { color: var(--color-accent); }
        .item-card .card-subtitle { display: block; margin-bottom: 15px; opacity: 0.8; font-size: 0.9rem; font-family: var(--font-main); } /* Применяем шрифт к подзаголовкам карточек */
        .item-card p { margin: 0; opacity: 0.9; font-family: var(--font-main); } /* Применяем шрифт к параграфам в карточках */

        /* --- Modern Menu --- */
        .menu-toggle {
            position: fixed; top: 30px; right: 30px; z-index: 1002; /* Увеличено z-index для видимости поверх всего, включая модальные окна */
            background: transparent; border: none; padding: 0; cursor: pointer;
            width: 30px; height: 24px; display: flex; flex-direction: column;
            justify-content: space-between; transition: transform 0.4s;
        }
        .menu-toggle:hover { transform: scale(1.1); }
        .menu-toggle .bar { background: #FFFFFF; height: 2px; width: 100%; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); transform-origin: right; }
        .menu-toggle.is-active .bar:nth-child(1) { transform: translateY(11px) rotate(-45deg); background: var(--color-accent); }
        .menu-toggle.is-active .bar:nth-child(2) { opacity: 0; }
        .menu-toggle.is-active .bar:nth-child(3) { transform: translateY(-11px) rotate(45deg); background: var(--color-accent); }
        .nav-overlay {
            position: fixed; top: 0; right: -100%; width: 400px; height: 100vh;
            background: transparent; z-index: 999;
            transition: right 0.6s cubic-bezier(0.77, 0, 0.175, 1); overflow: hidden;
        }
        .nav-overlay.is-active { right: 0; }
        .nav-menu { padding: 100px 40px; list-style: none; }
        .nav-menu li { margin-bottom: 25px; opacity: 0; transform: translateX(30px); transition: all 0.4s ease-out; }
        .nav-overlay.is-active .nav-menu li { opacity: 1; transform: translateX(0); }
        .nav-menu li:nth-child(1) { transition-delay: 0.1s; } .nav-menu li:nth-child(2) { transition-delay: 0.2s; }
        .nav-menu li:nth-child(3) { transition-delay: 0.3s; } .nav-menu li:nth-child(4) { transition-delay: 0.4s; }
        .nav-menu li:nth-child(5) { transition-delay: 0.5s; } .nav-menu li:nth-child(6) { transition-delay: 0.6s; }
        .nav-menu a { color: var(--color-text); font-size: 1.8rem; position: relative; padding-bottom: 5px; transition: all 0.3s ease-out; font-family: var(--font-main); } /* Применяем шрифт к ссылкам в меню */
        .nav-menu a:hover { color: var(--color-accent); transform: translateX(5px); }
        .nav-menu a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 1px; background: var(--color-accent); transition: width 0.4s; }
        .nav-menu a:hover::after { width: 100%; }

        /* --- Hero Section --- */
        .hero { min-height: 90vh; display: flex; flex-direction: column; justify-content: center; }
        .hero h1 { font-size: clamp(2.5rem, 8vw, 4.5rem); margin: 0 0 20px; line-height: 1.1; font-weight: 700; text-shadow: 0 0 15px rgba(184, 216, 232, 0.4); }
        .hero p { font-size: 1.4rem; max-width: 600px; margin-bottom: 40px; }
        .cta-button {
            display: inline-block; padding: 14px 32px; text-decoration: none; font-weight: 600;
            font-size: 1rem; color: var(--color-text); border: 1px solid var(--color-accent);
            background-color: rgba(44, 75, 90, 0.3); backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);
            transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            font-family: var(--font-main); /* Применяем шрифт к кнопке CTA */
        }
        .cta-button:hover { transform: translateY(-5px) scale(1.05); border-color: var(--color-text); box-shadow: 0 5px 25px 5px rgba(184, 216, 232, 0.4); }

        /* --- Modal Windows --- */
        #modal-container { position: relative; z-index: 1001; }
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex;
            justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .modal.is-active { opacity: 1; pointer-events: all; }
        .modal__content { 
            max-width: 800px; width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            text-align: left; padding: 0;
            position: relative; 
            border-radius: 8px;
            scrollbar-width: none;
            background-color: var(--color-card); /* Базовый фон модального окна */
            border: 1px solid var(--color-border);
            backdrop-filter: blur(15px); /* Применение блюра к фону самого модального окна */
            -webkit-backdrop-filter: blur(15px);
            transition: background-color 0.3s ease, backdrop-filter 0.3s ease; /* Плавность при изменении стилей */
            font-family: var(--font-main); /* Применяем шрифт к контенту модального окна */
        }
        /* Styles for when no custom background is present (making it transparent) */
        .modal__content.transparent-background {
            background-color: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            box-shadow: none; /* Optional: remove shadow if it's part of the glassmorphism */
        }

        .modal__content::-webkit-scrollbar {
            display: none;
        }
        /* --- Custom background styling --- */
        .modal__custom-background {
            position: fixed; /* Use fixed to keep it in place */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Помещаем под контент */
            overflow: hidden; /* Обрезаем все, что выходит за пределы */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            background-color: transparent; /* Убедимся, что сам контейнер фона прозрачен */
            opacity: 0; /* Изначально скрыто */
            transform: translateY(20px); /* Начальное смещение для анимации */
            transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* Плавность появления */
        }
        .modal.is-active .modal__custom-background {
            opacity: 1;
            transform: translateY(0);
            z-index: 8; /* Ниже контента модального окна, но над вебгл-канвасом */
        }

        /* --- Ensure content scrolls over static background --- */
        .modal__content.has-custom-background {
            background-color: transparent; /* Фон модального окна прозрачен */
            backdrop-filter: none; /* Блюр не нужен, если фон полностью перекрывает */
            z-index: 10; /* чтобы контент был поверх фона */
            position: relative; /* для z-index */
        }
        .modal__content.has-custom-background .modal__text-content {
            position: relative; /* Чтобы контент был поверх фоновых элементов */
            z-index: 10; /* Над фоном */
        }
        /* Ensure modal__media-viewer is also over the custom background if it exists */
        .modal__content.has-custom-background .modal__media-viewer {
             z-index: 9;
        }
        /* Ensure modal__close, modal__nav-btn are over custom background */
        .modal__close, .modal__nav-btn {
            z-index: 11;
        }

        /* Скрываем стандартный Three.js канвас, если используется кастомный фон */
        #webgl-canvas.hidden {
            opacity: 0;
            pointer-events: none; /* Чтобы не мешал кликам */
        }

        .modal__text-content {
             padding: 40px;
             max-width: 650px; /* MODIFIED: Set max-width for readability */
             margin: 0 auto; /* MODIFIED: Center the text block */
             position: relative; /* Чтобы контент был поверх фоновых элементов */
             z-index: 10; /* Над фоном */
             opacity: 0; transform: translateY(20px);
             transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* Анимация появления */
        }
        .modal__content h2, .modal__content p {
            /* REMOVED: animation properties here as they are handled by the parent '.modal.is-active' */
            font-family: var(--font-main); /* Применяем шрифт к заголовку и параграфам модалки */
        }
        /* Стили для появления элементов, когда модальное окно активно */
        .modal.is-active .modal__text-content,
        .modal.is-active .modal__content h2, 
        .modal.is-active .modal__content p, 
        .modal.is-active .modal__media-viewer, 
        .modal.is-active .modal__nav-btn
        /* .modal.is-active .modal__custom-background -- Теперь и кастомный фон появляется с анимацией */
        {
            opacity: 1; transform: translateY(0);
        }
        .modal.is-active .modal__close { transition-delay: 0.2s; }
        .modal.is-active .modal__media-viewer, .modal.is-active .modal__nav-btn { transition-delay: 0.3s; }
        .modal.is-active .modal__content h2 { transition-delay: 0.4s; }
        .modal.is-active .modal__content p { transition-delay: 0.5s; }
        .modal__content h2 { font-size: 2.5rem; margin-bottom: 20px; color: var(--color-accent); text-align: center; }
        .modal__content p { font-size: 1.2rem; line-height: 1.6; text-align: left; } /* MODIFIED: Align left for readability */
        /* MODIFIED: Add styling for paragraphs to allow for empty lines */
        .modal__content p { 
            margin-bottom: 1em; /* Standard paragraph spacing */
        }
        .modal__content p:last-child {
            margin-bottom: 0; /* No bottom margin for the last paragraph */
        }
        .modal__content p.empty-line {
            margin-bottom: 0;
            height: 1em; /* Or adjust as needed for visual spacing */
        }
        
        /* REMOVED: Modal close button from bottom-left */
        /* .modal__close { ... } */

        .modal__media-viewer {
            position: sticky; top: 0; z-index: 5;
            width: 100%; aspect-ratio: 16 / 9;
            background: rgba(3, 4, 9, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-border);
            opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .modal__media-viewer .media-item {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; visibility: hidden; transition: opacity 0.6s ease-in-out;
            display: flex; justify-content: center; align-items: center;
        }
        .modal__media-viewer .media-item.is-active { opacity: 1; visibility: visible; }
        .modal__media-viewer img { width: 100%; height: 100%; object-fit: cover; }
        .modal__media-viewer iframe { width: 100%; height: 100%; border: none; }
        .modal__nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.3); color: white; border: none;
            width: 40px; height: 60px; font-size: 2rem; cursor: pointer;
            transition: all 0.3s; z-index: 5; opacity: 0;
            display: flex; justify-content: center; align-items: center;
        }
        .modal__nav-btn:hover { background: rgba(0,0,0,0.6); }
        .modal__nav-btn.prev { left: 10px; border-radius: 5px 0 0 5px; }
        .modal__nav-btn.next { right: 10px; border-radius: 0 5px 5px 0; }
        .modal__nav-btn.hidden { display: none; }

        /* --- Admin Panel --- */
        #admin-panel {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(3, 4, 9, 0.95);
            z-index: 10000; display: none; overflow-y: auto; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        #admin-panel.active { display: block; }
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 250px; background: rgba(25, 29, 45, 0.8); padding: 30px; border-right: 1px solid var(--color-border); position: sticky; top: 0; height: 100vh; }
        .admin-sidebar h3 { margin-top: 0; color: var(--color-text); } /* Белый цвет */
        .admin-sidebar ul { list-style: none; padding: 0; }
        .admin-sidebar ul li { margin-bottom: 10px; }
        .admin-content { flex: 1; padding: 40px; }
        .admin-tabs { list-style: none; padding: 0; }
        .admin-tab { padding: 10px 0; cursor: pointer; transition: all 0.3s; color: var(--color-text); } /* Белый цвет */
        .admin-tab.active { color: var(--color-accent); font-weight: bold; }
        .admin-tab:not(.active):hover { color: var(--color-accent); transform: translateX(5px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        #admin-close-btn { position: absolute; top: 25px; right: 25px; background: none; border: none; color: var(--color-text); font-size: 2rem; cursor: pointer; transition: all 0.3s; line-height: 1; }
        #admin-close-btn:hover { color: var(--color-accent); transform: rotate(90deg); }
        .admin-section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--color-border); padding-bottom: 15px; margin-bottom: 30px; }
        .admin-section-header h2 { margin: 0; color: var(--color-text); } /* Белый цвет */
        .admin-item { background: var(--color-card); padding: 20px; border-radius: 8px; border: 1px solid var(--color-border); margin-bottom: 20px; }
        .admin-item-content { display: grid; grid-template-columns: 1fr; gap: 15px; }
        .admin-item label { font-size: 0.9rem; opacity: 0.8; margin-bottom: -10px; color: var(--color-text); } /* Белый цвет */
        .admin-item input, .admin-item textarea {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--color-border); color: var(--color-text);
            padding: 10px; border-radius: 4px; font-family: inherit; font-size: 1rem; transition: all 0.3s; box-sizing: border-box;
        }
        .admin-item input:disabled, .admin-item textarea:disabled { background: transparent; border-color: transparent; color: var(--color-text); }
        .admin-item input:focus, .admin-item textarea:focus { border-color: var(--color-accent); background: rgba(0,0,0,0.4); }
        .admin-item textarea { min-height: 120px; resize: vertical; line-height: 1.6; }
        .admin-item-actions { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }
        .admin-btn { padding: 8px 16px; border: 1px solid var(--color-accent); background: rgba(184, 216, 232, 0.1); color: var(--color-accent); border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .admin-btn:hover { background: rgba(184, 216, 232, 0.3); color: var(--color-text); }
        .admin-btn.delete-btn { border-color: #e57373; color: #e57373; }
        .admin-btn.delete-btn:hover { background: rgba(229, 115, 115, 0.3); color: var(--color-text); }
        .admin-btn.save-btn { display: none; }
        .admin-item.is-editing .edit-btn { display: none; }
        .admin-item.is-editing .save-btn { display: inline-block; }

        /* --- Reduced Motion & Responsive --- */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .animated-container {
                opacity: 1;
                transform: none;
                transition: none;
            }
            .animated-text span {
                opacity: 1;
                transform: none;
                animation: none;
            }
        }
        
        @media (max-width: 768px) {
            .animated-container { transform: translateX(-15px) rotate(-2deg); }
            .nav-overlay { width: 100%; }
            .hero h1 { font-size: 2.5rem; }
            .item-grid { grid-template-columns: 1fr; }
            .admin-container { flex-direction: column; }
            .admin-sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--color-border); position: static; height: auto; }
            .admin-content { padding: 20px; }
            .modal__content { padding: 0; }
            .modal__text-content { padding: 20px; }
            .modal__content h2 { font-size: 2rem; }
            /* REMOVED: .modal__close { left: 20px; bottom: 20px; } */
        }
        @media (max-width: 480px) {
            main { padding: 60px 15px; }
            section { margin-bottom: 60px; }
            .hero h1 { font-size: 2rem; }
            .nav-menu { padding: 80px 20px; }
            .nav-menu a { font-size: 1.5rem; }
            /* REMOVED: .modal__close { left: 15px; bottom: 15px; } */
        }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div></div>

    <canvas id="webgl-canvas"></canvas>

    <!-- Кнопка меню всегда видна поверх всего -->
    <button class="menu-toggle" aria-label="Toggle menu">
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>

    <div class="nav-overlay">
        <ul class="nav-menu">
            <li><a href="#hero">Home</a></li>
            <li><a href="#services">Services</a></li>
            <li><a href="#portfolio">Portfolio</a></li>
            <li><a href="#blog">Blog</a></li>
            <li><a href="#contact">Contact</a></li>
            <li><a href="#" id="admin-toggle">Admin</a></li>
        </ul>
    </div>

    <main>
        <section id="hero" class="hero"></section>
        <section id="services"></section>
        <section id="portfolio"></section>
        <section id="blog"></section>
    </main>

    <div id="modal-container"></div>

    <div id="admin-panel">
        <div class="admin-container">
            <div class="admin-sidebar">
                <h3>Admin Panel</h3>
                <ul class="admin-tabs">
                    <li class="admin-tab active" data-tab="home">Home</li>
                    <li class="admin-tab" data-tab="services">Services</li>
                    <li class="admin-tab" data-tab="portfolio">Portfolio</li>
                    <li class="admin-tab" data-tab="blog">Blog</li>
                </ul>
            </div>
            <div class="admin-content">
                <button id="admin-close-btn" title="Close Admin Panel">&times;</button>
                <div class="tab-content active" data-tab-content="home"></div>
                <div class="tab-content" data-tab-content="services"></div>
                <div class="tab-content" data-tab-content="portfolio"></div>
                <div class="tab-content" data-tab-content="blog"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        
        // --- DATA STORE ---
        const initialSiteData = {
            home: {
                title: "Crafting Digital Excellence",
                subtitle: "We create bespoke websites that elevate small businesses through elegant design and cutting-edge technology.",
                cta: "Start Your Project"
            },
            services: [
                {
                    id: 'service-1', title: 'Web Development', subtitle: 'From Landing Pages to E-Commerce',
                    description: 'We build fast, responsive, and secure websites tailored to your needs.',
                    modalContent: `Our development process focuses on clean code, performance, and scalability.
We use modern technologies to ensure your site stands the test of time.
Lorem ipsum dolor sit amet, consectetur adipiscing elit.

Sed non risus. Suspendisse lectus tortor, dignissim sit amet, adipiscing nec, ultricies sed, dolor.
Cras elementum ultrices diam. Maecenas ligula massa, varius a, semper congue, euismod non, mi.`,
                    cardMedia: ['https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=2070&auto=format&fit=crop'],
                    modalMedia: ['https://www.youtube.com/embed/Qdeot_p_B8s'],
                    modalCustomBackgroundHtml: '' // <-- New field for custom background HTML
                }
            ],
            portfolio: [
                {
                    id: 'portfolio-1', title: 'Project Alpha', subtitle: 'Corporate Website',
                    description: 'A sleek, modern website for a leading tech consultant.',
                    modalContent: `This project involved a complete redesign focusing on lead generation and clear communication of complex services.
The result was a 40% increase in user engagement.

Vivamus vestibulum ntulla nec ante. Praesent placerat. Fusce wisi.
Phasellus faucibus molestie nisl. Fusce ac felis sit amet ligula pharetra condimentum.
Maecenas egestas, ante et consectetur egestas, lectus est congue tellus, non mattis eros augue et magna.`,
                    cardMedia: ['https://images.unsplash.com/photo-1551288049-bebda4e38f71?q=80&w=2070&auto=format&fit=crop'],
                    modalMedia: [],
                    modalCustomBackgroundHtml: ''
                },
                 {
                    id: 'portfolio-2', title: 'Project Beta', subtitle: 'E-Commerce Store',
                    description: 'An elegant online store for a boutique fashion brand.',
                    modalContent: `We built a custom Shopify theme to reflect the brand's unique aesthetic, integrating features for a seamless shopping experience.

The platform is robust, scalable, and easy for the client to manage, resulting in a significant uplift in online sales and customer satisfaction.`,
                    cardMedia: ['https://images.unsplash.com/photo-1522204523234-8729aa6e3d5f?q=80&w=2070&auto=format&fit=crop'],
                    modalMedia: ['https://vimeo.com/394422933'],
                    modalCustomBackgroundHtml: `
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(184, 216, 232, 0.5), rgba(3, 4, 9, 0.8)); display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; text-align: center;">
                            <h2 style="font-size: 3rem; margin-bottom: 20px;">Custom Background Example</h2>
                            <p style="font-size: 1.2rem;">This content is part of the custom background.</p>
                            <p style="font-size: 1rem; opacity: 0.8;">It remains static while the modal content scrolls.</p>
                        </div>
                    `
                }
            ],
            blog: [
                {
                    id: 'article1', title: '10 Principles of Effective Web Design', subtitle: 'June 15, 2023',
                    description: 'Discover the fundamental principles that make websites both beautiful and functional.',
                    modalContent: `Теперь контент "парит" в воздухе над фоном.

Главная страница исчезает. Каждый элемент появляется с анимацией.
The quick brown fox jumps over the lazy dog.
The five boxing wizards jump quickly.
Pack my box with five dozen liquor jugs.
When zombies arrive, quickly fax judge Pat.
Heavy boxes perform quick waltzes and jigs.`,
                    cardMedia: ['https://images.unsplash.com/photo-1524758631624-e2822e304c36?q=80&w=2070&auto=format&fit=crop'],
                    modalMedia: ['https://images.unsplash.com/photo-1556740738-b6a63e27c4df?q=80&w=2070&auto=format&fit=crop'],
                    modalCustomBackgroundHtml: ''
                },
                {
                    id: 'article2', title: 'SEO Strategies for Small Businesses', subtitle: 'May 28, 2023',
                    description: 'Learn how to improve your online visibility without breaking the bank.',
                    modalContent: 'Это модальное окно полностью соответствует изначальному запросу.',
                    cardMedia: [],
                    modalMedia: ['https://www.youtube.com/embed/668nUCeBHyY'],
                    modalCustomBackgroundHtml: ''
                }
            ]
        };
        let siteData = {};

        // --- CORE FUNCTIONS ---
        const saveData = () => localStorage.setItem('siteData', JSON.stringify(siteData));
        const loadData = () => {
            const storedData = localStorage.getItem('siteData');
            siteData = storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(initialSiteData));
        };
        
        // --- RENDER FUNCTIONS ---
        function renderAllContent() {
            renderHero();
            renderSection('services', 'Our Services', siteData.services);
            renderSection('portfolio', 'Our Work', siteData.portfolio);
            renderSection('blog', 'Latest Insights', siteData.blog);
            renderModals();
            initIntersectionObservers();
        }

        function renderHero() {
            const { title, subtitle, cta } = siteData.home;
            document.getElementById('hero').innerHTML = `
                <h1 class="animated-container animated-text">${title}</h1>
                <p class="animated-container animated-text">${subtitle}</p>
                <a href="#contact" class="cta-button animated-container">${cta}</a>
            `;
        }

        function renderSection(id, title, items) {
            const section = document.getElementById(id);
            if (!section) return;

            const itemsHTML = items.map(item => {
                const firstImage = item.cardMedia && item.cardMedia.length > 0 ? item.cardMedia[0] : null;
                const imageStyle = firstImage ? `style="background-image: url('${firstImage}')"` : '';

                return `
                <article class="item-card animated-container" data-modal-id="${item.id}">
                    <div class="item-card__image" ${imageStyle} data-media-images="${(item.cardMedia || []).join(',')}">
                        ${(item.cardMedia || []).map(url => isYoutubeUrl(url) ? 
                            `<div class="media-item" data-type="video" style="display:none"><iframe src="${getYoutubeEmbedUrl(url)}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>` : 
                            `<div class="media-item" data-type="image" style="display:none"><img src="${url}" alt="${item.title}"></div>`
                        ).join('')}
                    </div>
                    <div class="item-card__content">
                        <h3 class="animated-text">${item.title}</h3>
                        <div class="card-subtitle animated-text">${item.subtitle}</div>
                        <p class="animated-text">${item.description}</p>
                    </div>
                </article>
                `;
            }).join('');
            section.innerHTML = `
                <div class="animated-container"><h2 class="animated-text">${title}</h2></div>
                <div class="item-grid">${itemsHTML}</div>
            `;
            initCardSlideshows(section);
        }
        
        // --- Custom Background Handling ---
        let activeModalId = null; // Keep track of the currently open modal
        let currentCustomBackgroundCleanup = null; // Function to clean up previous background
        let currentModalMediaIntervalCleanup = null; // Cleanup for modal slideshow

        function handleCustomModalBackground(modalElement) {
            const itemId = modalElement.id;
            const itemData = getItemDataById(itemId);
            const customBackgroundHtml = itemData?.modalCustomBackgroundHtml;
            
            const modalCustomBackgroundDiv = modalElement.querySelector('.modal__custom-background');
            const modalContentElement = modalElement.querySelector('.modal__content');

            // --- Cleanup Previous Background ---
            if (currentCustomBackgroundCleanup) {
                currentCustomBackgroundCleanup(); // Execute cleanup for the previous modal's background
                currentCustomBackgroundCleanup = null;
            }
            // --- End Cleanup ---

            if (customBackgroundHtml && modalCustomBackgroundDiv && modalContentElement) {
                modalContentElement.classList.add('has-custom-background');
                modalCustomBackgroundDiv.style.display = 'flex';
                modalCustomBackgroundDiv.innerHTML = customBackgroundHtml;

                // --- Script execution for custom background ---
                // This block finds any <script> tags injected via innerHTML and re-creates them
                // so the browser executes them. This is crucial for running animations.
                const scripts = modalCustomBackgroundDiv.querySelectorAll('script');
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    // Copy all attributes from the original script to the new one
                    Array.from(script.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    
                    // Copy the script content
                    newScript.textContent = script.textContent;

                    // Replace the non-executable script with the new, executable one
                    script.parentNode.replaceChild(newScript, script);
                });
                // --- End Script execution ---

                setThreeJsVisibility(false);

                currentCustomBackgroundCleanup = () => {
                    if (modalCustomBackgroundDiv) {
                        modalCustomBackgroundDiv.innerHTML = '';
                        modalCustomBackgroundDiv.style.display = 'none';
                    }
                    modalContentElement.classList.remove('has-custom-background');
                    setThreeJsVisibility(true);
                };

            } else {
                if (modalCustomBackgroundDiv) {
                    modalCustomBackgroundDiv.innerHTML = '';
                    modalCustomBackgroundDiv.style.display = 'none';
                }
                if (modalContentElement) {
                    modalContentElement.classList.remove('has-custom-background');
                    modalContentElement.classList.add('transparent-background');
                }
                setThreeJsVisibility(true);
            }
        }

        // Helper to get item data by its ID
        function getItemDataById(itemId) {
            const allItems = [...siteData.services, ...siteData.portfolio, ...siteData.blog];
            return allItems.find(item => item.id === itemId);
        }

        function renderModals() {
            const container = document.getElementById('modal-container');
            const allItems = [...siteData.services, ...siteData.portfolio, ...siteData.blog];
            
            container.innerHTML = allItems.map(item => {
                const mediaHTML = (item.modalMedia || []).map((url, index) => {
                    if (isYoutubeUrl(url)) {
                        const embedUrl = getYoutubeEmbedUrl(url);
                        return `<div class="media-item" data-type="video"><iframe src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                    } else if (url.includes('vimeo.com')) {
                        const videoId = url.split('vimeo.com/')[1].split('?')[0];
                        return `<div class="media-item" data-type="video"><iframe src="https://player.vimeo.com/video/${videoId}?autoplay=1&loop=1&title=0&byline=0&portrait=0" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe></div>`;
                    } else {
                        return `<div class="media-item" data-type="image"><img src="${url}" alt="${item.title}"></div>`;
                    }
                }).join('');

                return `
                <div class="modal" id="${item.id}">
                    <div class="modal__content">
                        <!-- REMOVED: Modal close button from bottom-left -->
                        
                        ${item.modalMedia && item.modalMedia.length > 0 ? `
                        <div class="modal__media-viewer">
                            ${mediaHTML}
                        </div>` : ''}
                        
                        <!-- Custom background container -->
                        <div class="modal__custom-background"></div>
                        
                        <div class="modal__text-content">
                            <h2 class="animated-text">${item.title}</h2>
                            ${item.modalContent.split('\n\n').map(paragraph => 
                                `<p>${paragraph.replace(/\n/g, '<br>')}</p>`
                            ).join('')}
                        </div>
                        
                        <!-- Navigation buttons for media viewer -->
                        ${item.modalMedia && item.modalMedia.length > 1 ? `
                            <button class="modal__nav-btn prev" aria-label="Previous media">&#9664;</button>
                            <button class="modal__nav-btn next" aria-label="Next media">&#9654;</button>
                        ` : ''}
                    </div>
                </div>
                `;
            }).join('');
            initModalEventListeners();
        }

        // --- ADMIN PANEL RENDER ---
        function renderAdminPanel() {
            renderAdminHome();
            renderAdminSection('services');
            renderAdminSection('portfolio');
            renderAdminSection('blog');
        }

        function renderAdminHome() {
            const container = document.querySelector('.tab-content[data-tab-content="home"]');
            const data = siteData.home;
            container.innerHTML = `
                <div class="admin-section-header"><h2>Home Page Content</h2></div>
                <div class="admin-item" id="admin-home-item">
                    <div class="admin-item-content">
                        <label for="home-title">Title</label><input type="text" id="home-title" value="${escapeHtml(data.title)}" disabled>
                        <label for="home-subtitle">Subtitle</label><textarea id="home-subtitle" rows="4" disabled>${escapeHtml(data.subtitle)}</textarea>
                        <label for="home-cta">CTA Button Text</label><input type="text" id="home-cta" value="${escapeHtml(data.cta)}" disabled>
                    </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn edit-btn" data-action="edit-home">Edit</button>
                        <button class="admin-btn save-btn" data-action="save-home">Save</button>
                    </div>
                </div>`;
        }
        
        function renderAdminSection(key) {
             const container = document.querySelector(`.tab-content[data-tab-content="${key}"]`);
             const title = key.charAt(0).toUpperCase() + key.slice(1);
             const itemsHTML = siteData[key].map(item => `
                <div class="admin-item" data-id="${item.id}" data-key="${key}">
                    <div class="admin-item-content">
                        <label>Title</label><input type="text" class="admin-input-title" value="${escapeHtml(item.title)}" disabled>
                        <label>Subtitle / Date</label><input type="text" class="admin-input-subtitle" value="${escapeHtml(item.subtitle)}" disabled>
                        <label>Card Description</label><textarea class="admin-input-description" rows="3" disabled>${escapeHtml(item.description)}</textarea>
                        <label>Modal Content</label><textarea class="admin-input-modalContent" rows="5" disabled>${escapeHtml(item.modalContent)}</textarea>
                        <label>Card Media (Image URLs, one per line)</label><textarea class="admin-input-cardMedia" rows="4" disabled>${escapeHtml((item.cardMedia || []).join('\n'))}</textarea>
                        <label>Modal Media (Image/YouTube/Vimeo URLs, one per line)</label><textarea class="admin-input-modalMedia" rows="4" disabled>${escapeHtml((item.modalMedia || []).join('\n'))}</textarea>
                        
                        <!-- NEW FIELD FOR CUSTOM MODAL BACKGROUND HTML -->
                        <label>Modal Background HTML</label>
                        <textarea class="admin-input-modalCustomBackgroundHtml" rows="4" disabled>${escapeHtml(item.modalCustomBackgroundHtml || '')}</textarea>
                        <!-- END NEW FIELD -->
                    </div>
                    <div class="admin-item-actions">
                        <button class="admin-btn edit-btn" data-action="edit">Edit</button>
                        <button class="admin-btn save-btn" data-action="save">Save</button>
                        <button class="admin-btn delete-btn" data-action="delete">Delete</button>
                    </div>
                </div>`).join('');
             container.innerHTML = `
                <div class="admin-section-header"><h2>Manage ${title}</h2><button class="admin-btn" data-action="add" data-key="${key}">+ Add New</button></div>${itemsHTML}`;
        }

        // --- Helper Functions ---
        function isYoutubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
            return youtubeRegex.test(url);
        }

        function getYoutubeEmbedUrl(url) {
            let videoId;
            try {
                const urlObj = new URL(url);
                if (urlObj.hostname === 'youtu.be') {
                    videoId = urlObj.pathname.slice(1);
                } else {
                    videoId = urlObj.searchParams.get('v');
                }
            } catch(e) { return null; }
            if (!videoId) return null;
            // Added mute=1 for autoplay and removed controls to match the visual style
            return `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&mute=1&controls=0&loop=1&playlist=${videoId}&origin=${window.location.origin}`;
        }

        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        // --- Slideshow Functions ---
        let slideshowIntervals = [];
        function initCardSlideshows(section) {
            slideshowIntervals.forEach(clearInterval);
            slideshowIntervals = [];

            section.querySelectorAll('.item-card__image').forEach(imageEl => {
                const mediaItems = imageEl.querySelectorAll('.media-item');
                if (mediaItems.length > 1) {
                    let currentIndex = 0;
                    
                    // Show first item
                    mediaItems[currentIndex].style.display = 'block';
                    
                    const intervalId = setInterval(() => {
                        // Fade out current item
                        mediaItems[currentIndex].style.opacity = '0';
                        
                        setTimeout(() => {
                            // Hide current item
                            mediaItems[currentIndex].style.display = 'none';
                            mediaItems[currentIndex].style.opacity = '1';
                            
                            // Move to next item
                            currentIndex = (currentIndex + 1) % mediaItems.length;
                            
                            // Show next item
                            mediaItems[currentIndex].style.display = 'block';
                            mediaItems[currentIndex].style.opacity = '0';
                            setTimeout(() => {
                                mediaItems[currentIndex].style.opacity = '1';
                            }, 50);
                        }, 800); // Fade out duration
                    }, 3000); // Total delay between transitions
                    
                    slideshowIntervals.push(intervalId);
                } else if (mediaItems.length === 1) {
                    // Show single item
                    mediaItems[0].style.display = 'block';
                }
            });
        }
        
        function initializeModalSlideshow(modal) {
            const mediaItems = modal.querySelectorAll('.media-item');
            const prevBtn = modal.querySelector('.modal__nav-btn.prev');
            const nextBtn = modal.querySelector('.modal__nav-btn.next');

            if (mediaItems.length <= 1) {
                if (mediaItems.length === 1) {
                    mediaItems[0].classList.add('is-active');
                }
                if(prevBtn) prevBtn.classList.add('hidden');
                if(nextBtn) nextBtn.classList.add('hidden');
                return;
            }

            let currentIndex = 0;
            mediaItems[currentIndex].classList.add('is-active');
            
            // Show navigation buttons if there's more than one media item
            if(prevBtn) prevBtn.classList.remove('hidden');
            if(nextBtn) nextBtn.classList.remove('hidden');

            const updateNavigation = () => {
                mediaItems.forEach((item, index) => {
                    item.classList.toggle('is-active', index === currentIndex);
                });
            };

            const handleNext = () => {
                mediaItems[currentIndex].classList.remove('is-active');
                currentIndex = (currentIndex + 1) % mediaItems.length;
                mediaItems[currentIndex].classList.add('is-active');
            };

            const handlePrev = () => {
                mediaItems[currentIndex].classList.remove('is-active');
                currentIndex = (currentIndex - 1 + mediaItems.length) % mediaItems.length;
                mediaItems[currentIndex].classList.add('is-active');
            };
            
            // Clear previous interval if it exists
            if (currentModalMediaIntervalCleanup) {
                currentModalMediaIntervalCleanup();
            }

            // Set new interval
            const intervalId = setInterval(handleNext, 3000);
            currentModalMediaIntervalCleanup = () => clearInterval(intervalId);

            // Add event listeners for navigation buttons
            if (nextBtn) {
                nextBtn.onclick = () => {
                    handleNext();
                    // Reset interval timer on manual navigation
                    clearInterval(intervalId);
                    // Re-start interval to continue auto-play after manual navigation
                    currentModalMediaIntervalCleanup = setInterval(handleNext, 3000); 
                };
            }
            if (prevBtn) {
                prevBtn.onclick = () => {
                    handlePrev();
                    // Reset interval timer on manual navigation
                    clearInterval(intervalId);
                    // Re-start interval to continue auto-play after manual navigation
                    currentModalMediaIntervalCleanup = setInterval(handleNext, 3000); 
                };
            }

            // Return a cleanup function for the interval
            return () => clearInterval(intervalId);
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        window.addEventListener('load', () => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
            
            loadData();
            renderAllContent();
            renderAdminPanel();
            initStaticEventListeners();
            animate(); // Start Three.js animation
        });

        // MODIFIED: Added logic to handle menu toggle when a modal is open
        const menuToggle = document.querySelector('.menu-toggle');
        const navOverlay = document.querySelector('.nav-overlay');
        const body = document.body;

        function toggleNav() {
            body.classList.toggle('nav-is-open');
            menuToggle.classList.toggle('is-active');
            navOverlay.classList.toggle('is-active');
        }

        function closeModal(modal) {
            modal.classList.remove('is-active');
            body.classList.remove('modal-is-open');
            
            // Reset videos: stop playback and reset source
            modal.querySelectorAll('iframe').forEach(iframe => {
                const currentSrc = iframe.getAttribute('src');
                iframe.setAttribute('src', ''); // Stop playback
                // Small delay to ensure src is cleared, then restore it
                setTimeout(() => iframe.setAttribute('src', currentSrc), 10);
            });

            // Clean up custom background and restore Three.js canvas visibility
            if (currentCustomBackgroundCleanup) {
                currentCustomBackgroundCleanup(); // Execute cleanup
                currentCustomBackgroundCleanup = null; // Clear the reference
            }
            
            // Clean up modal slideshow interval
            if (currentModalMediaIntervalCleanup) {
                currentModalMediaIntervalCleanup();
                currentModalMediaIntervalCleanup = null;
            }
            
            const content = modal.querySelector('.modal__content');
            if (content) content.scrollTop = 0;
        }

        function initStaticEventListeners() {
            menuToggle.addEventListener('click', () => {
                if (body.classList.contains('modal-is-open')) {
                    // If a modal is open, clicking the menu toggle closes the modal
                    const activeModal = document.querySelector('.modal.is-active');
                    if (activeModal) {
                        closeModal(activeModal);
                    }
                } else {
                    // Otherwise, toggle the navigation menu
                    toggleNav();
                }
            });
            
            document.querySelectorAll('.nav-menu a').forEach(link => {
                if (link.id !== 'admin-toggle') {
                    link.addEventListener('click', () => {
                        if (body.classList.contains('nav-is-open')) {
                            toggleNav(); // Close nav if a link is clicked
                        }
                    });
                }
            });
            document.getElementById('admin-toggle').addEventListener('click', e => { e.preventDefault(); document.getElementById('admin-panel').classList.add('active'); });
            document.getElementById('admin-close-btn').addEventListener('click', () => document.getElementById('admin-panel').classList.remove('active'));
            document.querySelector('.admin-tabs').addEventListener('click', e => {
                if (e.target.matches('.admin-tab')) {
                    document.querySelectorAll('.admin-tab, .tab-content').forEach(el => el.classList.remove('active'));
                    e.target.classList.add('active');
                    document.querySelector(`.tab-content[data-tab-content="${e.target.dataset.tab}"]`).classList.add('active');
                }
            });
            document.querySelector('.admin-content').addEventListener('click', handleAdminActions);
            document.querySelector('main').addEventListener('click', e => {
                const card = e.target.closest('.item-card');
                if (card) {
                    const modal = document.getElementById(card.dataset.modalId);
                    if (modal) {
                        body.classList.add('modal-is-open');
                        modal.classList.add('is-active');
                        // Initialize media slideshow and custom background *after* modal is active
                        initializeModalSlideshow(modal); // Initialize media slideshow
                        handleCustomModalBackground(modal); // Handle custom background and Three.js visibility
                    }
                }
            });
        }
        
        function initModalEventListeners() {
            document.querySelectorAll('.modal').forEach(modal => {
                // Close modal if clicking outside the content (on the modal background overlay)
                modal.addEventListener('click', e => { 
                    // Check if the click target is the modal itself AND not its content or navigation buttons
                    if (e.target === modal) { 
                        closeModal(modal); 
                    }
                });
            });

            // Handle Escape key to close modal
            window.addEventListener('keydown', e => {
                if (e.key === "Escape") {
                    const activeModal = document.querySelector('.modal.is-active');
                    if (activeModal) {
                        closeModal(activeModal);
                    }
                }
            });

            // Handle navigation buttons within the modal media viewer
            document.querySelectorAll('.modal__nav-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent click from propagating to the modal background
                    const modal = button.closest('.modal');
                    const mediaItems = modal.querySelectorAll('.media-item');
                    let currentIndex = Array.from(mediaItems).findIndex(item => item.classList.contains('is-active'));
                    
                    if (!modal || mediaItems.length <= 1) return;

                    if (button.classList.contains('prev')) {
                        mediaItems[currentIndex].classList.remove('is-active');
                        currentIndex = (currentIndex - 1 + mediaItems.length) % mediaItems.length;
                        mediaItems[currentIndex].classList.add('is-active');
                    } else if (button.classList.contains('next')) {
                        mediaItems[currentIndex].classList.remove('is-active');
                        currentIndex = (currentIndex + 1) % mediaItems.length;
                        mediaItems[currentIndex].classList.add('is-active');
                    }
                });
            });
        }

        // --- DYNAMIC CONTENT & ANIMATION LOGIC ---
        function handleAdminActions(e) {
            const target = e.target;
            const action = target.dataset.action;
            if (!action) return;

            const itemEl = target.closest('.admin-item');
            const isEditing = itemEl ? itemEl.classList.contains('is-editing') : false;

            // --- Handling Home Content ---
            if (action === 'edit-home' || action === 'save-home') {
                itemEl.classList.toggle('is-editing', !isEditing);
                itemEl.querySelectorAll('input, textarea').forEach(input => input.disabled = isEditing);
                if (action === 'save-home') {
                    siteData.home = { 
                        title: itemEl.querySelector('#home-title').value, 
                        subtitle: itemEl.querySelector('#home-subtitle').value, 
                        cta: itemEl.querySelector('#home-cta').value 
                    };
                    saveData();
                    renderHero();
                    // Re-run activation for hero elements to apply animation on re-render
                    const heroSection = document.getElementById('hero');
                    const containers = heroSection.querySelectorAll('.animated-container');
                    containers.forEach(container => activateContainer(container));
                }
                return;
            }

            // --- Handling Items (Services, Portfolio, Blog) ---
            const key = target.dataset.key || itemEl.dataset.key;
            const id = itemEl ? itemEl.dataset.id : null;

            switch(action) {
                case 'edit': 
                    itemEl.classList.add('is-editing'); 
                    itemEl.querySelectorAll('input, textarea').forEach(input => input.disabled = false); 
                    break;
                case 'save': {
                    const itemData = siteData[key].find(item => item.id === id);
                    if (itemData) {
                        itemData.title = itemEl.querySelector('.admin-input-title').value;
                        itemData.subtitle = itemEl.querySelector('.admin-input-subtitle').value;
                        itemData.description = itemEl.querySelector('.admin-input-description').value;
                        itemData.modalContent = itemEl.querySelector('.admin-input-modalContent').value;
                        itemData.cardMedia = itemEl.querySelector('.admin-input-cardMedia').value.split('\n').map(s => s.trim()).filter(Boolean);
                        itemData.modalMedia = itemEl.querySelector('.admin-input-modalMedia').value.split('\n').map(s => s.trim()).filter(Boolean);
                        itemData.modalCustomBackgroundHtml = itemEl.querySelector('.admin-input-modalCustomBackgroundHtml').value;
                    }
                    saveData(); 
                    renderAllContent(); // Re-render all content to reflect changes
                    renderAdminSection(key); // Re-render the admin section to update display and disable inputs
                    break;
                }
                case 'delete':
                    if (confirm('Are you sure you want to delete this item?')) {
                        siteData[key] = siteData[key].filter(item => item.id !== id);
                        saveData(); 
                        renderAllContent(); 
                        renderAdminSection(key);
                    }
                    break;
                case 'add':
                    const newItemId = `${key}-${Date.now()}`; // Generate a unique ID for the new item
                    siteData[key].push({ 
                        id: newItemId, 
                        title: 'New Item', 
                        subtitle: 'New Subtitle', 
                        description: 'Enter description here.', 
                        modalContent: 'Enter modal content here.', 
                        cardMedia: [], 
                        modalMedia: [],
                        modalCustomBackgroundHtml: '' // Initialize with empty custom background
                    });
                    saveData(); 
                    renderAllContent(); 
                    renderAdminSection(key); // Re-render to show the new item
                    break;
            }
        }

        function animateTextLetters(element) {
            if (!element || element.dataset.animated) return;
            element.dataset.animated = true;

            element.classList.add('is-animating'); // Restore text color

            const text = element.textContent.trim();
            element.innerHTML = '';

            // Split by whitespace to get words and preserve them
            const words = text.split(/\s+/);

            words.forEach((word, wordIndex) => {
                const wordWrapper = document.createElement('span');
                wordWrapper.style.display = 'inline-block'; // Keeps the word from breaking

                word.split('').forEach((char) => {
                    const span = document.createElement('span');
                    span.textContent = char;
                    // Add a slight random delay to each character's animation for a more organic feel
                    span.style.animationDelay = `${Math.random() * 0.5}s`; 
                    wordWrapper.appendChild(span);
                });
                element.appendChild(wordWrapper);

                // Add a space after each word, except the last one
                if (wordIndex < words.length - 1) {
                    element.appendChild(document.createTextNode(' '));
                }
            });
        }

        function activateContainer(container) {
            if (container.classList.contains('active')) return;
            container.classList.add('active');

            const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReducedMotion) {
                container.querySelectorAll('.animated-text').forEach(animateTextLetters);
                return;
            }
            
            // Use a small timeout to ensure the element is rendered before animation starts
            setTimeout(() => {
                if (container.classList.contains('animated-text')) {
                    animateTextLetters(container);
                } else {
                    container.querySelectorAll('.animated-text').forEach(animateTextLetters);
                }
            }, 300); // Adjust delay as needed
        }
        
        let observer;
        function initIntersectionObservers() {
             if (observer) observer.disconnect();
             
             observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const section = entry.target;
                        const containers = section.querySelectorAll('.animated-container');
                        
                        containers.forEach((container, index) => {
                            const delay = index * 150; // Stagger animation by index
                            setTimeout(() => {
                                activateContainer(container);
                            }, delay);
                        });
                        
                        obs.unobserve(section); // Stop observing once elements are activated
                    }
                });
            }, { threshold: 0.4 }); // Trigger when 40% of the section is visible
            
            document.querySelectorAll("main > section").forEach(section => {
                observer.observe(section);
            });
        }

        // --- THREE.JS SCENE SETUP ---
        let crystalMaterial;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;
        const canvas = document.getElementById("webgl-canvas");
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        scene.add(new THREE.AmbientLight(0x404040, 2));
        const pointLight1 = new THREE.PointLight(0x00aaff, 30, 20);
        pointLight1.position.set(5, 5, 5);
        scene.add(pointLight1);
        const crystalGroup = new THREE.Group();
        scene.add(crystalGroup);
        crystalMaterial = new THREE.ShaderMaterial({
            uniforms: { time: { value: 0 }, color1: { value: new THREE.Color(0xb8d8e8) }, color2: { value: new THREE.Color(0x1d2a34) }, }, // Adjusted color2 for better contrast
            vertexShader: `varying vec3 vNormal; varying vec3 vPosition; void main() { vNormal = normalize(normalMatrix * normal); vPosition = position; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `uniform float time; uniform vec3 color1; uniform vec3 color2; varying vec3 vNormal; float snoise(vec3 v){ const vec2 C = vec2(1.0/6.0, 1.0/3.0) ; const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); vec3 i = floor(v + dot(v, C.yyy) ); vec3 x0 = v - i + dot(i, C.xxx) ; vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min( g.xyz, l.zxy ); vec3 i2 = max( g.xyz, l.zxy ); vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy; i = mod(i, 289.0); vec4 p = mod(((i.z + vec4(0.0, i1.z, i2.z, 1.0 ))*34.0+1.0)* (i.z + vec4(0.0, i1.z, i2.z, 1.0 )) + i.y + vec4(0.0, i1.y, i2.y, 1.0 ), 289.0); p = mod(((p)*34.0+1.0)*(p) + i.x + vec4(0.0, i1.x, i2.x, 1.0 ), 289.0); vec4 j = p - 49.0 * floor(p * (1.0/7.0) * (1.0/7.0)); vec4 x_ = floor(j * (1.0/7.0)); vec4 y_ = floor(j - 7.0 * x_ ); vec4 x = x_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 y = y_ * (2.0/7.0) - 1.0 + (1.0/7.0); vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4( x.xy, y.xy ); vec4 b1 = vec4( x.zw, y.zw ); vec4 s0 = floor(b0)*2.0 + 1.0; vec4 s1 = floor(b1)*2.0 + 1.0; vec4 sh = -step(h, vec4(0.0)); vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy ; vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww ; vec3 p0 = vec3(a0.xy,h.x); vec3 p1 = vec3(a0.zw,h.y); vec3 p2 = vec3(a1.xy,h.z); vec3 p3 = vec3(a1.zw,h.w); vec4 norm = inversesqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3))); p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0); m = m * m; return 42.0 * dot( m*m, vec4( dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3) ) ); } void main() { float noise = snoise(vNormal * 3.0 + time * 0.1); vec3 baseColor = mix(color1, color2, vNormal.y * 0.5 + 0.5); float fresnel = pow(1.0 - abs(dot(vNormal, vec3(0.0, 0.0, 1.0))), 3.0); vec3 finalColor = baseColor + fresnel * vec3(0.8, 0.9, 1.0) * 0.5; finalColor += noise * 0.2; gl_FragColor = vec4(finalColor, fresnel * 0.8 + 0.2); }`,
            transparent: true, blending: THREE.AdditiveBlending, depthWrite: false,
        });
        const coreCrystal = new THREE.Mesh(new THREE.IcosahedronGeometry(0.8, 1), crystalMaterial);
        crystalGroup.add(coreCrystal);
        let branches = [];
        let crystalGrowth = 0;
        const addBranch = () => {
            if (branches.length > 50) return;
            const branch = new THREE.Mesh(new THREE.IcosahedronGeometry(0.1 + Math.random() * 0.4, 0), crystalMaterial);
            const phi = Math.random() * Math.PI * 2, theta = Math.acos(Math.random() * 2 - 1), radius = 1 + Math.random() * crystalGrowth;
            branch.position.set( radius * Math.sin(theta) * Math.cos(phi), radius * Math.sin(theta) * Math.sin(phi), radius * Math.cos(theta) );
            branch.rotation.set(Math.random(), Math.random(), Math.random());
            branch.scale.set(0.01, 0.01, 0.01);
            crystalGroup.add(branch);
            branches.push({ mesh: branch, life: 0, maxLife: 0.5 + Math.random() * 1.5 });
        };
        const clock = new THREE.Clock();
        let scrollFraction = 0, introComplete = false;
        const introDuration = 5;

        // Control Three.js visibility
        function setThreeJsVisibility(visible) {
            if (visible) {
                canvas.classList.remove('hidden');
            } else {
                canvas.classList.add('hidden');
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            const elapsedTime = clock.getElapsedTime();
            crystalMaterial.uniforms.time.value = elapsedTime;
            let introProgress = introComplete ? 1.0 : Math.min(elapsedTime / introDuration, 1.0);
            if (introProgress >= 1.0) introComplete = true;
            crystalGrowth = Math.max(introProgress * 1.5, Math.min(scrollFraction * 5, 2.5));
            if (crystalGrowth > 0.1 && Math.random() > 0.9) addBranch();
            camera.position.z = 5 - Math.max(introProgress * 1.0, scrollFraction * 2);
            camera.position.y = scrollFraction * 1;
            camera.lookAt(scene.position);
            crystalGroup.rotation.y += 0.001;
            crystalGroup.rotation.x += 0.0005;
            coreCrystal.scale.setScalar(1 + crystalGrowth * 0.5);
            branches.forEach(b => { if (b.life < b.maxLife) { b.life += 0.01; b.mesh.scale.setScalar(Math.sin(b.life / b.maxLife * Math.PI * 0.5)); } });
            renderer.render(scene, camera);
        }

        // Event listeners for scroll and resize (kept for global animations)
        window.addEventListener("scroll", () => {
            const scrollableHeight = document.body.scrollHeight - window.innerHeight;
            scrollFraction = scrollableHeight > 0 ? window.scrollY / scrollableHeight : 0;
        });
        window.addEventListener("resize", () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>